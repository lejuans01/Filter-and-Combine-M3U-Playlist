<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Filter and Combine M3U Playlist</title>
  <style>
    /* Light and Dark Themes */
    body {
      font-family: Arial, sans-serif;
      background-color: #ffffff;
      color: #333;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s;
    }

    body.dark-mode {
      background-color: #333;
      color: #f1f1f1;
    }

    .container {
      width: 80%;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .input-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .input-section input {
      width: 40%;
      padding: 10px;
      margin-right: 10px;
    }

    .input-section button {
      padding: 10px 20px;
      background-color: #00796b;
      color: white;
      border: none;
      cursor: pointer;
    }

    .input-section button:hover {
      background-color: #004d40;
    }

    .categories {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .category-btn {
      padding: 10px 20px;
      background-color: #00796b;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }

    .category-btn:hover {
      background-color: #004d40;
    }

    .selected-category {
      background-color: #004d40;
    }

    .info {
      text-align: center;
      margin-top: 20px;
    }

    #downloadLinkContainer {
      display: none;
    }

    /* Theme Toggle Button */
    .theme-toggle-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: #00796b;
      color: white;
      border: none;
      cursor: pointer;
    }

    .theme-toggle-btn:hover {
      background-color: #004d40;
    }
  </style>
</head>
<body>
  <button class="theme-toggle-btn" onclick="toggleTheme()">Toggle Dark/Light Theme</button>

  <div class="container">
    <h1>Filter and Combine M3U Playlist</h1>
    <div class="input-section">
      <p>Upload an M3U or M3U8 file or paste a URL to process.</p>
      <input type="file" id="m3uFileInput" />
      <input type="text" id="m3uUrlInput" placeholder="Enter M3U URL" />
      <button onclick="processInput()">Process</button>
    </div>

    <div id="previewSection" class="preview-section" style="display: none;">
      <h3>Categories in Uploaded Content:</h3>
      <div id="categoryList" class="categories"></div>
      <button onclick="addToCombinedContent()">Add Selected Categories</button>
    </div>

    <div id="downloadLinkContainer">
      <h3>Your Combined Playlist is Ready:</h3>
      <a id="downloadLink" href="#" download="Combined_Playlist.m3u" onclick="prepareDownload()">Download Combined Playlist</a>
    </div>
    <div class="info">
      <p>Only Valid .M3U and .M3U8 Formats are Supported. Malformed Entries will be Skipped.</p>
      <p><strong>If URL Fails, Download Playlist 1st.</strong></p>
      <p><i>"Created by: LeJuan ATP"</i></p>
    </div>
  </div>

  <script>
    // Switch between light and dark theme
    function toggleTheme() {
      const body = document.body;
      body.classList.toggle('dark-mode');
    }

    let currentContent = '';
    let combinedContent = '';
    let isFirstHeader = true; // Ensure only one #EXTM3U
    let fallbackGroupName = ''; // For grouping based on filename if no group-title is present

    function processInput() {
        const fileInput = document.getElementById('m3uFileInput');
        const urlInput = document.getElementById('m3uUrlInput');
        const file = fileInput.files[0];
        const url = urlInput.value.trim();

        if (file) {
            fallbackGroupName = file.name.replace(/\.[^/.]+$/, ''); // Remove file extension
            const reader = new FileReader();
            reader.onload = function (event) {
                currentContent = cleanM3UContent(event.target.result);
                displayCategories(currentContent);
            };
            reader.readAsText(file);
        } else if (url) {
            fallbackGroupName = 'Unknown'; // Default fallback for URLs
            fetch(url)
                .then(response => response.text())
                .then(text => {
                    currentContent = cleanM3UContent(text);
                    displayCategories(currentContent);
                })
                .catch(err => alert("Error fetching URL: " + err));
        } else {
            alert("Please upload a file or enter a URL.");
        }
    }

    function cleanM3UContent(content) {
        const lines = content.split('\n').map(line => line.trim());
        const cleanedLines = [];
        const urlRegex = /^https?:\/\//;

        let lastMetadata = '';
        let hasGroupTitles = false; // Flag to detect if group-title exists

        for (const line of lines) {
            if (line.startsWith('#EXTM3U')) {
                if (isFirstHeader) {
                    cleanedLines.push(line); // Add only the first #EXTM3U
                    isFirstHeader = false;
                }
            } else if (line.startsWith('#EXTINF:')) {
                const groupMatch = line.match(/group-title="([^"]+)"/);
                if (groupMatch) {
                    hasGroupTitles = true; // Detect group-title in the file
                }
                lastMetadata = line; // Store the metadata line
            } else if (urlRegex.test(line)) {
                if (lastMetadata) {
                    // Add group-title if missing, based on fallback
                    if (!hasGroupTitles) {
                        lastMetadata = lastMetadata.replace(
                            /(group-title="[^"]*")?/,
                            `group-title="${fallbackGroupName}"`
                        );
                    }
                    cleanedLines.push(lastMetadata); // Add metadata + URL pair
                    lastMetadata = ''; // Reset metadata
                }
                cleanedLines.push(line);
            }
        }

        return cleanedLines.join('\n');
    }

    function displayCategories(content) {
        const lines = content.split('\n');
        const categories = new Set();

        // Extract categories
        lines.forEach(line => {
            const match = line.match(/group-title="([^"]+)"/);
            if (match) {
                categories.add(match[1]);
            }
        });

        const categoryList = document.getElementById('categoryList');
        categoryList.innerHTML = '';

        categories.forEach(category => {
            const categoryButton = document.createElement('button');
            categoryButton.classList.add('category-btn');
            categoryButton.textContent = category;
            categoryButton.onclick = function () {
                categoryButton.classList.toggle('selected-category'); // Toggle selection
            };
            categoryList.appendChild(categoryButton);
        });

        // Show the preview section
        document.getElementById('previewSection').style.display = 'block';
    }

    function addToCombinedContent() {
        const selectedCategories = document.querySelectorAll('.selected-category');
        const selectedCategoryNames = Array.from(selectedCategories).map(button => button.textContent);

        const lines = currentContent.split('\n');
        const filteredLines = [];
        let includeNextLine = false;

        lines.forEach(line => {
            const match = line.match(/group-title="([^"]+)"/);
            if (match) {
                includeNextLine = selectedCategoryNames.includes(match[1]);
            }
            if (includeNextLine || line.startsWith('#EXTM3U')) {
                filteredLines.push(line);
            }
        });

        // Append to combined content
        if (combinedContent) {
            combinedContent += '\n'; // Ensure a single newline between files
        }
        combinedContent += filteredLines.join('\n');

        alert(`Selected categories added to the combined playlist.`);
        document.getElementById('downloadLinkContainer').style.display = 'block';
    }

    function prepareDownload() {
        const blob = new Blob([combinedContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const downloadLink = document.getElementById('downloadLink');
        downloadLink.href = url;
    }
  </script>
</body>
</html>
